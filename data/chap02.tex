% !TeX root = ../thuthesis-example.tex

\chapter{信息整理与分析}

\section{数据来源简介}

\subsection{《中国药典》与中成药处方定量}

通过定量方法寻找有效的中药靶点，要求我们有足够的中药组成含量数据，而在临床实际中，往往并不是使用单一的中药，而是使用中医传统理论选取特定的中药组合，通过协同作用达到治疗目的。因此，我们需要的原始数据和模型最终的评估对象均为中药处方而非单一药材。这就需要足够数量的成分确定，且被临床实践确证有效的中药处方作为正例，而没有被实践选择的其他众多药材组合作为反例。《中国药典》作为一部有国家法律效力、规范包括中药在内国内药品生产和应用的权威性文件，其在中成药处方定量中的可用性高于古籍等其他资料；与此同时，它还以 HTML 网页的形式公开，非常方便进行数据的批量爬取，因此成为本研究处方-药材定量的主要依据。\cite{2020-ie}

\subsection{中药材定量数据库ccTCM}

严格来说，中药处方并不是各药材的简单混合，根据制剂类型的不同还可能涉及不同的提取、反应过程，但是在本研究中，我们无法建模这些复杂的处理过程，而认为经炮制后药材的成分含量结果可以基本反映最终生效的药物成分。这是后续的定量分析得以在处方-药材-化合物-基因的层级上进行的基本假设，否则就需要对每一种成药分别进行成分鉴定。此前，已经有多个项目对中药材的化合物组分进行了测定和整理，如 ccTCM\cite{Yang_Zhu_Yao_Chen_Chen_Gu_Jiang_Chen_Zhang_Wu_et_al._2023}, ITCM\cite{Tian_Zhang_Yuan_Wang_Lv_Wang_Fang_Fu_Yang_Zu_et_al._2023}, BATMAN-TCM\cite{Kong_Liu_Zhang_Cheng_Mei_Li_Liu_Diao_Ma_Jiang_et_al._2024} 等，而且相关论文均发表于近两年之内，具有较高的时效性。其中，ccTCM 提供较为完备的原始数据的下载，包括药材与其化合物组分、化合物与其可能影响表达的基因的关联表，可以进行离线分析，而不需要通过调用效率有限的 API，因此成为本研究中药材-化合物-基因定量的主要依据。

\subsection{蛋白互作网络STRING}

STRING, 即 Search Tool for the Retrieval of Interaction Gene/Proteins，是一个通用蛋白质互作网络数据库，包括多种生物体系的蛋白质互作关系，以及蛋白质与其他生物分子的关联。\cite{Szklarczyk_Gable_Nastou_Lyon_Kirsch_Pyysalo_Doncheva_Legeay_Fang_Bork_et_al._2021} 在本研究中，因为之前的两步数据整理已经将处方与具体基因联系起来，因此在基因层面我们可以不再依赖专门的中医药数据库，而可以使用更加通用的 STRING。STRING 可以针对一组输入的基因，返回它们之间的蛋白质互作网络，包括原始数据和可视化的形式，这对于我们在基因层面进行定量分析是非常有帮助的。

\section{《中国药典》处方收集整理}

《中国药典》全四部均可通过 \url{https://ydz.chp.org.cn} 获取，其组织形式非常有规律。\cite{中华人民共和国药典}对于我们需要的第一部中的中药数据，首先使用一个 URL 参数 \texttt{bookId=1}，然后目录页即使用 \texttt{directoryId} 参数，第一部的目录范围为 1-16；内容页使用 \texttt{entryId} 参数，第一部的页码范围为 1-2282，其中 665-2282 即为我们需要的成方制剂和单味制剂，不再需要通过目录获取。因此，我们可以直接获取所有所需的静态页面进行分析，乃至本地部署使用。

对于药方这一层次结构且数据量较大的爬取对象，本步骤选用了 YAML 格式进行存储，从而实现了增量化存储，并有利于后续人工修改标注。存储层级为页码-处方名-处方药材及重量列表。页码信息有助于在归纳出热点处方之后回到《中国药典》进行反查。

在得到原始数据后，我们并无法直接使用得到的处方药材列表：一部分处方只给出了药材的名称而缺乏定量，另一部分给出的药材名称或者特定的制法无法在数据库中找到对应，这些数据无法使用，只能去除，或通过其他资料进行后续补充；中药的同物异名现象也影响到了药材的在数据库中的搜索，因此，我们需要借助中药学、植物学、矿物学等知识，在此基础上进行一定的人工整理。通过和在下一部分中介绍的 ccTCM 数据库进行对比，我们一共得到完整可用的处方 303 个，共涉及 156 味不同药材，从而限定了本研究的数据范围。

需要注意的是，如果能够通过结合其他文献或者进行实验的方式补充已知成分的药材列表，我们可以进一步扩大可用的处方范围，如下图为《中国药典》中处方在我们使用的ccTCM中缺失药材数据的分布情况：

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{figures/unlisted_medicinals_distribution.png}
  \caption{《中国药典》中处方在ccTCM中缺失药材数据的分布情况}
  \label{fig:missing_herbs}
\end{figure}

\section{ccTCM 数据库整理}

ccTCM 本身提供了使用中药、化合物或者基因靶标进行在线搜索的平台，但是这种访问方式不利于大规模的数据整理，因此我们选择了直接下载 ccTCM 的原始数据进行离线分析。这些数据以 TSV 格式存储在 \texttt{TCM\_information}, \texttt{Compound\_information}, \texttt{Target\_information} 这些基础信息文件和 \texttt{TCM\_compound-v1}, \texttt{Compound\_target-v1} 这两层关联文件之中，可以使用数据库合并的逻辑直接得到我们想要的信息，即药材中具体化合物的定量及特定化合物关联各基因的作用强度。其中，化合物定量往往可以给出一个具体的百分比范围，取其平均值进行后续计算即可，但是仅有 42\% 的化合物-基因关联存在以某种形式定量的作用强度，

而且存在量纲不一致、大量作用强度只使用占位值（如 $100000~\mathrm{nM}$ ）的问题，几乎没有进行横向比较的可能，在本研究中只能暂时不考虑作用强度问题，或在某种程度上将其视为可学习的参数。我们实际得到的药材-基因定量关联权重是考虑所有与某种基因有关联的化合物，对它们在药材中的占比进行求和的结果，即：


$$
w_{\text{herb-gene}} = \sum_{\text{compound} \in \text{herb}} w_{\text{herb-compound}} \mathbf{1}_{\text{compound relates to gene}}
$$

这个求和可以在ccTCM表格处理中直接进行，而不需要即时计算，最终我们对每个药材得到并存储一个基因-权重字典应用于后续的基因关联网络构建。

\section{STRING查询与整理}

根据2024年5月31日的数据，STRING 数据库共收录 12535 种生物体的近 6000 万个蛋白质， 互作关系的规模大于 200 亿，是一个非常庞大的数据库，但是其提供了丰富的查询接口，并编写了详细的说明文档（\url{https://string-db.org/help/api/}）。在这里，我们希望探究的是药材之前的相互作用，可分解为这样的子问题：遍历处方涉及的药材中的所有二元药材配对，这两个药材关联基因的信息已经在前一步中获得，然后我们将这两个基因列表合并后调用STRING的 \texttt{network} API，就可以得到以原始 TSV 或 JSON 格式返回的基因互作分数网络，包括基因近邻分数、融合分数等多项细分关联度和STRING给出的一个综合分数，或者直接给出可视化图像。接下来，我们就可以利用原来的列表从返回的网络中筛选所需的交互关联，以及作为对照的药材内部关联，如下面“二冬膏”的例子：


\begin{figure}[H]
  \centering
  \begin{minipage}[b]{0.4\textwidth}
      \centering
      \includegraphics[width=\textwidth]{tiandong.png} % 这里替换为你的图片文件名
  \end{minipage}
  \hspace{0.05\textwidth} % 间隔
  \begin{minipage}[b]{0.4\textwidth}
      \centering
      \includegraphics[width=\textwidth]{maidong.png} % 这里替换为你的图片文件名
  \end{minipage}

  \begin{minipage}[b]{0.95\textwidth}
      \centering
      \includegraphics[width=\textwidth]{tiandong-maidong.png} % 这里替换为你的图片文件名
  \end{minipage}
  \caption{“二冬膏”中药材天冬、麦冬及合并后的基因关联网络示意图}
\end{figure}

“二冬膏”是一个较为简单、只包含两种药材的处方，方便用来作为示例。如果我们分别向STRING的\texttt{network} API 发送天冬关联的基因列表（ACHE, UGT1A4, SLCO1B3, SLCO1B1）和麦冬关联的基因列表（CDH1, VIM, CTNNB1, SRC, AKT1, ITGB1, MMP9, TGFB1, PTK2, CDH2）得到的是药材内部的基因关联网络，如左上、右上两图；而将这两个列表合并后发送，得到的是涉及两药材的全基因关联网络，如下图。我们不仅可以根据原来的基因列表筛选出仅发生在两药材之间的关联，还可以将其与药材内部的关联进行对比，或者衡量连通度等关联增益。在这个例子中，天冬关联的4个基因原本被分为不连通的两个部分，但是在与麦冬关联的基因列表合并后，这两个部分被连接了起来，最终的关联图只有一个连通部分，这可能意味着更强的协同作用。

需要注意的是，不同药材的已知关联基因数目可能有极大的差异。上述天冬、麦冬只有10个以内的已知关联基因，而有些药材可能有数千个，以下列出了本研究中已知关联基因较多的几个药材：

\begin{figure}[H]
  \centering
  \includegraphics[width=0.8\textwidth]{gene_counts.png}
  \caption{关联基因数大于500的药材及相应基因数}
  \label{fig:top_genes}
\end{figure}

这种关联基因数的不均衡分布不仅会带来后续处理中的一些问题，如关联基因较多的药材可能会自然使得所属网络有显著的关联增益，使得药材始终被认为是“有效的”，或者某些药材关联的基因会完全覆盖其他药材，而且对 API 本身的调用也有影响。经过测试，\texttt{network} API所能接受的最大基因数目为2000，而我们的数据中已经有关联超过2000个基因的药材，但由于广泛存在的基因重复，实际任意药材涉及到的总基因数不超过4000，此时就可以采取分组提交的方法克服这一困难。对于任意一个长度不超过4000的基因列表，将其近似均分为4份，记为 $a, b, c, d$, 然后依次提交 $ab, ac, ad, bc, bd, be$ 这6个列表，最后再将返回的网络合并即可。

如果仅仅进行现有药方的分析，我们只需要对各个药方中真实存在的药材配对进行查询。但是，我们在后续比较中可能需要足够的负例，即并不真实存在、大概率无临床价值的随机药物组合。这大约是7.2倍的查询量，即从真实处方中出现的1685个药材配对扩展到全部$\frac{1}{2} \times 156 \times (156 - 1) = 12090$种可能。

需要注意的是，虽然STRING支持使用 Uniprot ID， NCBI Gene ID和自建的STRING ID进行查询，但是 \texttt{network} API的返回结果中仅有 STRING ID和NCBI Gene ID, 但ccTCM提供的是Uniprot ID，这导致数据反查时遇到困难。同时，STRING数据库未收录ccTCM中的部分基因。为此，我们借助STRING的\texttt{get\_string\_ids} API得到这三种基因表示间的对应关系，在本地建立相应的映射表，并从药材关联的基因中除去未被STRING收录的部分。